<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Non-root user (Rootless) | AQS's Docker workshop</title>
    <meta name="description" content="Workshop details ">
    <meta name="generator" content="VitePress v1.2.3">
    <link rel="preload stylesheet" href="/assets/style.xDLpOBuA.css" as="style">
    
    <script type="module" src="/assets/app.DDvPDogZ.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.BzdiqRf3.js">
    <link rel="modulepreload" href="/assets/chunks/theme.ClCYFBD5.js">
    <link rel="modulepreload" href="/assets/non-root.md.Bn3lAFVN.lean.js">
    <link rel="stylesheet" href="https://unpkg.com/keyboard-css@1.2.4/dist/css/main.min.css">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-d8b57b2d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-d8b57b2d data-v-7ad780c2><div class="VPNavBar has-sidebar top" data-v-7ad780c2 data-v-844edcde><div class="wrapper" data-v-844edcde><div class="container" data-v-844edcde><div class="title" data-v-844edcde><div class="VPNavBarTitle has-sidebar" data-v-844edcde data-v-0ad69264><a class="title" href="/" data-v-0ad69264><!--[--><!--]--><!----><span data-v-0ad69264>AQS&#39;s Docker workshop</span><!--[--><!--]--></a></div></div><div class="content" data-v-844edcde><div class="content-body" data-v-844edcde><!--[--><!--]--><div class="VPNavBarSearch search" data-v-844edcde><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-844edcde data-v-f732b5d0><span id="main-nav-aria-label" class="visually-hidden" data-v-f732b5d0>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-f732b5d0 data-v-08fbf4b6><!--[--><span data-v-08fbf4b6>Home</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-844edcde data-v-283b26e9><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-283b26e9 data-v-7df97737 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-7df97737></span><span class="vpi-moon moon" data-v-7df97737></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-844edcde data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/seenark" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-844edcde data-v-8e87c032 data-v-af5898d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-af5898d3><span class="vpi-more-horizontal icon" data-v-af5898d3></span></button><div class="menu" data-v-af5898d3><div class="VPMenu" data-v-af5898d3 data-v-e42ed9b3><!----><!--[--><!--[--><!----><div class="group" data-v-8e87c032><div class="item appearance" data-v-8e87c032><p class="label" data-v-8e87c032>Appearance</p><div class="appearance-action" data-v-8e87c032><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-8e87c032 data-v-7df97737 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-7df97737></span><span class="vpi-moon moon" data-v-7df97737></span><!--]--></span></span></button></div></div></div><div class="group" data-v-8e87c032><div class="item social-links" data-v-8e87c032><div class="VPSocialLinks social-links-list" data-v-8e87c032 data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/seenark" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-844edcde data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-844edcde><div class="divider-line" data-v-844edcde></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-d8b57b2d data-v-2488c25a><div class="container" data-v-2488c25a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-2488c25a><span class="vpi-align-left menu-icon" data-v-2488c25a></span><span class="menu-text" data-v-2488c25a>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-2488c25a data-v-883964e0><button data-v-883964e0>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-d8b57b2d data-v-4871f9f5><div class="curtain" data-v-4871f9f5></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-4871f9f5><span class="visually-hidden" id="sidebar-aria-label" data-v-4871f9f5> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-4871f9f5><section class="VPSidebarItem level-0 has-active" data-v-4871f9f5 data-v-c24f735a><div class="item" role="button" tabindex="0" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><h2 class="text" data-v-c24f735a>Workshop</h2><!----></div><div class="items" data-v-c24f735a><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/installing.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>01. Installation</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/concepts.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>02. Knowing Docker Concepts</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/what-and-why.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>03. What & Why</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/cli.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>04. Docker basic commands</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/hands-on-react.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>05. Hands-on React + Vite + TS</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/multi-stage.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>06. Multi-stage</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/hands-on-backend.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>07. Hands-on Backend</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/volumes.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>08. Volumes</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/hands-on-next.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>09. Hands-on SSR Next</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/network.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>10. Networks</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/docker-compose.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>11. Docker compose</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/postgres-example.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>12. Postgres example</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/portainer.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>13. Portainer</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/caddy.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>14. Caddy reverse proxy</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/non-root.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>15. Non-root user</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/prune.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>16. Docker prune</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/markdown-examples.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>Markdown Examples</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c24f735a data-v-c24f735a><div class="item" data-v-c24f735a><div class="indicator" data-v-c24f735a></div><a class="VPLink link link" href="/api-examples.html" data-v-c24f735a><!--[--><p class="text" data-v-c24f735a>Runtime API Examples</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-d8b57b2d data-v-9a6c75ad><div class="VPDoc has-sidebar has-aside" data-v-9a6c75ad data-v-e6f2a212><!--[--><!--]--><div class="container" data-v-e6f2a212><div class="aside" data-v-e6f2a212><div class="aside-curtain" data-v-e6f2a212></div><div class="aside-container" data-v-e6f2a212><div class="aside-content" data-v-e6f2a212><div class="VPDocAside" data-v-e6f2a212 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-cb998dce data-v-f610f197><div class="content" data-v-f610f197><div class="outline-marker" data-v-f610f197></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-f610f197>On this page</div><ul class="VPDocOutlineItem root" data-v-f610f197 data-v-53c99d69><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e6f2a212><div class="content-container" data-v-e6f2a212><!--[--><!--]--><main class="main" data-v-e6f2a212><div style="position:relative;" class="vp-doc _non-root" data-v-e6f2a212><div><h1 id="non-root-user-rootless" tabindex="-1">Non-root user (Rootless) <a class="header-anchor" href="#non-root-user-rootless" aria-label="Permalink to &quot;Non-root user (Rootless)&quot;">​</a></h1><h2 id="problem" tabindex="-1">Problem <a class="header-anchor" href="#problem" aria-label="Permalink to &quot;Problem&quot;">​</a></h2><p>ใน Linux root-user จะทำงานได้ทุกอย่างเพราะมีสิทธิ์เป็นเหมือน admin เลย ใน Docker ก็เหมือนกันเพราะทำ Linux อีกที ถ้าเกิดว่า Container เราโดนเจาะ แล้ว container นั้นใช้ root user ในการรัน command ต่างๆ ก็เท่ากับว่าคนที่เจาะเข้ามาได้ ได้สิทธิ์ admin ไปเลยในทันที และ Docker deamon มันทำงานด้วยสิทธิ์ root อยู่แล้วก็มีโอกาสเสี่ยงที่คนเจาะจะออกมาที่ docker daemon ได้แล้วควบคุมเครื่อง Host ได้อีกที</p><p>ฉนั้นเราจะป้องกันไว้ก่อนด้วยการเปลี่ยนไปใช้ non-root user แทน การใช้ non-root user จะทำให้สิทธิ์ในการใช้งาน Container ลดลง เราจะให้ใช้สิทธิ์เท่าที่จำเป็น เป็นการจำกัดสิทธิ์ในการใช้งานไว้</p><h2 id="uid-gid" tabindex="-1">UID &amp; GID <a class="header-anchor" href="#uid-gid" aria-label="Permalink to &quot;UID &amp; GID&quot;">​</a></h2><p>user ใน Linux จะประกอบไปด้วย 2 ส่วน</p><ol><li>UID = User ID</li><li>GID = Group ID</li></ol><p>สร้าง group ด้วยคำสั่ง</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addgroup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --gid</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1001</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nodejs</span></span></code></pre></div><p>สร้าง user ด้วยคำสั่ง</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">adduser</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --uid</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1001</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nonroot`</span></span></code></pre></div><h2 id="nextjs-dockerfile" tabindex="-1">NextJS Dockerfile <a class="header-anchor" href="#nextjs-dockerfile" aria-label="Permalink to &quot;NextJS Dockerfile&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark has-highlighted vp-code" tabindex="0"><code><span class="line"><span>FROM node:18-alpine AS base</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Install dependencies only when needed</span></span>
<span class="line"><span>FROM base AS deps</span></span>
<span class="line"><span># Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.</span></span>
<span class="line"><span>RUN apk add --no-cache libc6-compat</span></span>
<span class="line"><span>WORKDIR /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Install dependencies based on the preferred package manager</span></span>
<span class="line"><span>COPY package.json yarn.lock* package-lock.json* pnpm-lock.yaml* ./</span></span>
<span class="line"><span>RUN \</span></span>
<span class="line"><span>  if [ -f yarn.lock ]; then yarn --frozen-lockfile; \</span></span>
<span class="line"><span>  elif [ -f package-lock.json ]; then npm ci; \</span></span>
<span class="line"><span>  elif [ -f pnpm-lock.yaml ]; then corepack enable pnpm &amp;&amp; pnpm i --frozen-lockfile; \</span></span>
<span class="line"><span>  else echo &quot;Lockfile not found.&quot; &amp;&amp; exit 1; \</span></span>
<span class="line"><span>  fi</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># Rebuild the source code only when needed</span></span>
<span class="line"><span>FROM base AS builder</span></span>
<span class="line"><span>WORKDIR /app</span></span>
<span class="line"><span>COPY --from=deps /app/node_modules ./node_modules</span></span>
<span class="line"><span>COPY . .</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Next.js collects completely anonymous telemetry data about general usage.</span></span>
<span class="line"><span># Learn more here: https://nextjs.org/telemetry</span></span>
<span class="line"><span># Uncomment the following line in case you want to disable telemetry during the build.</span></span>
<span class="line"><span># ENV NEXT_TELEMETRY_DISABLED 1</span></span>
<span class="line"><span></span></span>
<span class="line"><span>RUN \</span></span>
<span class="line"><span>  if [ -f yarn.lock ]; then yarn run build; \</span></span>
<span class="line"><span>  elif [ -f package-lock.json ]; then npm run build; \</span></span>
<span class="line"><span>  elif [ -f pnpm-lock.yaml ]; then corepack enable pnpm &amp;&amp; pnpm run build; \</span></span>
<span class="line"><span>  else echo &quot;Lockfile not found.&quot; &amp;&amp; exit 1; \</span></span>
<span class="line"><span>  fi</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Production image, copy all the files and run next</span></span>
<span class="line"><span>FROM base AS runner</span></span>
<span class="line"><span>WORKDIR /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ENV NODE_ENV production</span></span>
<span class="line"><span># Uncomment the following line in case you want to disable telemetry during runtime.</span></span>
<span class="line"><span># ENV NEXT_TELEMETRY_DISABLED 1</span></span>
<span class="line"><span></span></span>
<span class="line highlighted warning"><span>RUN addgroup --system --gid 1001 nodejs</span></span>
<span class="line highlighted warning"><span>RUN adduser --system --uid 1001 nextjs</span></span>
<span class="line"><span></span></span>
<span class="line"><span>COPY --from=builder /app/public ./public</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Set the correct permission for prerender cache</span></span>
<span class="line"><span>RUN mkdir .next</span></span>
<span class="line highlighted warning"><span>RUN chown nextjs:nodejs .next</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Automatically leverage output traces to reduce image size</span></span>
<span class="line"><span># https://nextjs.org/docs/advanced-features/output-file-tracing</span></span>
<span class="line highlighted warning"><span>COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./</span></span>
<span class="line highlighted warning"><span>COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static</span></span>
<span class="line"><span></span></span>
<span class="line highlighted warning"><span>USER nextjs</span></span>
<span class="line"><span></span></span>
<span class="line"><span>EXPOSE 3000</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ENV PORT 3000</span></span>
<span class="line"><span></span></span>
<span class="line"><span># server.js is created by next build from the standalone output</span></span>
<span class="line"><span># https://nextjs.org/docs/pages/api-reference/next-config-js/output</span></span>
<span class="line"><span>CMD HOSTNAME=&quot;0.0.0.0&quot; node server.js</span></span></code></pre></div><p>จะเห็นว่า Dockerfile ที่ Next เตรียมมาให้แล้วมันใส่ User + Group มาให้ครบแล้ว ซึ่งเป็นตัวอย่างที่ดีมากๆ ถ้าใครต้องเขียน Dockerfile เอง เอา Dockerfile ของ Next เป็นตัวอย่างได้เลย ดีมากๆ</p><h2 id="let-s-update-backend-s-dockerfile" tabindex="-1">Let&#39;s update backend&#39;s Dockerfile <a class="header-anchor" href="#let-s-update-backend-s-dockerfile" aria-label="Permalink to &quot;Let&#39;s update backend&#39;s Dockerfile&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark has-diff vp-code" tabindex="0"><code><span class="line"><span># syntax=docker/dockerfile:1</span></span>
<span class="line"><span>ARG NODE_VERSION=22.2.0</span></span>
<span class="line"><span>ARG PNPM_VERSION=8.15.5</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Build</span></span>
<span class="line"><span>FROM node:${NODE_VERSION}-alpine AS build</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Install pnpm.</span></span>
<span class="line"><span>RUN --mount=type=cache,target=/root/.npm \</span></span>
<span class="line"><span>  npm install -g pnpm@${PNPM_VERSION}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>WORKDIR /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span>RUN --mount=type=bind,source=package.json,target=package.json \</span></span>
<span class="line"><span>  --mount=type=bind,source=pnpm-lock.yaml,target=pnpm-lock.yaml \</span></span>
<span class="line"><span>  --mount=type=cache,target=/root/.local/share/pnpm/store \</span></span>
<span class="line"><span>  pnpm install --frozen-lockfile</span></span>
<span class="line"><span></span></span>
<span class="line"><span>COPY . .</span></span>
<span class="line"><span></span></span>
<span class="line"><span>RUN pnpm run build &amp;&amp; pnpm prune --prod</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Final</span></span>
<span class="line"><span>FROM node:${NODE_VERSION}-alpine AS runner</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ENV NODE_ENV=production</span></span>
<span class="line"><span>WORKDIR /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># add nonroot user and group</span></span>
<span class="line diff add"><span>RUN addgroup --system --gid 1001 nodejs &amp;&amp; adduser --system --uid 1001 nonroot</span></span>
<span class="line"><span></span></span>
<span class="line"><span># make uploads folder </span></span>
<span class="line diff add"><span>RUN mkdir -p ./uploads &amp;&amp; chmod 700 ./uploads &amp;&amp; chown -R nonroot:nodejs ./uploads</span></span>
<span class="line"><span></span></span>
<span class="line"><span># when copy use flag --chown=&lt;user&gt;:&lt;group&gt;</span></span>
<span class="line diff add"><span>COPY --from=build --chown=nonroot:nodejs /app/dist ./dist</span></span>
<span class="line diff add"><span>COPY --from=build --chown=nonroot:nodejs /app/node_modules ./node_modules</span></span>
<span class="line diff add"><span>COPY --from=build --chown=nonroot:nodejs /app/package.json ./package.json</span></span>
<span class="line"><span></span></span>
<span class="line"><span># finally use nonroot user</span></span>
<span class="line"><span>USER nonroot</span></span>
<span class="line"><span></span></span>
<span class="line"><span>EXPOSE 3333</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CMD [&quot;node&quot;, &quot;dist/index.js&quot;]</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-e6f2a212 data-v-5941af80><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-5941af80><span class="visually-hidden" id="doc-footer-aria-label" data-v-5941af80>Pager</span><div class="pager" data-v-5941af80><a class="VPLink link pager-link prev" href="/caddy.html" data-v-5941af80><!--[--><span class="desc" data-v-5941af80>Previous page</span><span class="title" data-v-5941af80>14. Caddy reverse proxy</span><!--]--></a></div><div class="pager" data-v-5941af80><a class="VPLink link pager-link next" href="/prune.html" data-v-5941af80><!--[--><span class="desc" data-v-5941af80>Next page</span><span class="title" data-v-5941af80>16. Docker prune</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"cli.md\":\"BnIMcxjt\",\"concepts.md\":\"DWYWf_td\",\"api-examples.md\":\"DtwFd5t5\",\"index.md\":\"BzM-rhd6\",\"markdown-examples.md\":\"BYAkNNDb\",\"caddy.md\":\"CLcr73b1\",\"portainer.md\":\"2O8gGckL\",\"hands-on-react.md\":\"D-ZIHIxY\",\"readme.md\":\"DqixN48b\",\"docker-compose.md\":\"BjTYbeUB\",\"what-and-why.md\":\"DngnmC5a\",\"multi-stage.md\":\"CL4RrFEq\",\"hands-on-next.md\":\"5JANvKl_\",\"installing.md\":\"Co_JE9-8\",\"volumes.md\":\"CQXVGLTS\",\"network.md\":\"ThUcSznc\",\"postgres-example.md\":\"D4fb1HL5\",\"hands-on-backend.md\":\"Ry-o5RJc\",\"prune.md\":\"Bs_aFfYy\",\"non-root.md\":\"Bn3lAFVN\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"AQS's Docker workshop\",\"description\":\"Workshop details \",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Home\",\"link\":\"/\"}],\"sidebar\":[{\"text\":\"Workshop\",\"items\":[{\"text\":\"01. Installation\",\"link\":\"/installing\"},{\"text\":\"02. Knowing Docker Concepts\",\"link\":\"/concepts\"},{\"text\":\"03. What & Why\",\"link\":\"/what-and-why\"},{\"text\":\"04. Docker basic commands\",\"link\":\"/cli\"},{\"text\":\"05. Hands-on React + Vite + TS\",\"link\":\"/hands-on-react\"},{\"text\":\"06. Multi-stage\",\"link\":\"/multi-stage\"},{\"text\":\"07. Hands-on Backend\",\"link\":\"/hands-on-backend\"},{\"text\":\"08. Volumes\",\"link\":\"/volumes\"},{\"text\":\"09. Hands-on SSR Next\",\"link\":\"/hands-on-next\"},{\"text\":\"10. Networks\",\"link\":\"/network\"},{\"text\":\"11. Docker compose\",\"link\":\"/docker-compose\"},{\"text\":\"12. Postgres example\",\"link\":\"/postgres-example\"},{\"text\":\"13. Portainer\",\"link\":\"/portainer\"},{\"text\":\"14. Caddy reverse proxy\",\"link\":\"/caddy\"},{\"text\":\"15. Non-root user\",\"link\":\"/non-root\"},{\"text\":\"16. Docker prune\",\"link\":\"/prune\"},{\"text\":\"Markdown Examples\",\"link\":\"/markdown-examples\"},{\"text\":\"Runtime API Examples\",\"link\":\"/api-examples\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/seenark\"}],\"search\":{\"provider\":\"local\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>